{% extends 'base.html' %}

{% block title %}Y2A-Auto - 系统设置{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="settings-page-header">
        <div>
            <h2 class="mb-1">系统设置</h2>
            <p class="section-lead mb-0">集中管理自动化流程、AI服务、网络代理与安全策略。</p>
        </div>
        <div class="settings-page-tags">
            <span class="badge rounded-pill text-bg-light">Workflow</span>
            <span class="badge rounded-pill text-bg-light">AI</span>
            <span class="badge rounded-pill text-bg-light">Security</span>
        </div>
    </div>

    <div class="row settings-layout">
        <div class="col-lg-3 mb-3">
            <div class="settings-nav" id="settings-nav">
                <div class="settings-nav-folder" data-folder="workflow">
                    <button type="button" class="settings-folder-toggle" aria-expanded="true">
                        <i class="bi bi-diagram-3"></i>
                        <span>流程工作台</span>
                        <i class="bi bi-chevron-up ms-auto folder-caret"></i>
                    </button>
                    <div class="settings-folder-body nav flex-column nav-pills" role="tablist" aria-orientation="vertical">
                        <a class="nav-link active" id="vtab-general-tab" data-bs-toggle="pill" href="#vtab-general" role="tab" aria-controls="vtab-general" aria-selected="true">
                            <i class="bi bi-sliders"></i> 通用
                        </a>
                        <a class="nav-link" id="vtab-youtube-tab" data-bs-toggle="pill" href="#vtab-youtube" role="tab" aria-controls="vtab-youtube" aria-selected="false">
                            <i class="bi bi-download"></i> 下载与代理
                        </a>
                        <a class="nav-link" id="vtab-acfun-tab" data-bs-toggle="pill" href="#vtab-acfun" role="tab" aria-controls="vtab-acfun" aria-selected="false">
                            <i class="bi bi-person-badge"></i> AcFun账号
                        </a>
                        <a class="nav-link" id="vtab-concurrency-tab" data-bs-toggle="pill" href="#vtab-concurrency" role="tab" aria-controls="vtab-concurrency" aria-selected="false">
                            <i class="bi bi-cpu"></i> 并发与日志
                        </a>
                    </div>
                </div>

                <div class="settings-nav-folder" data-folder="ai">
                    <button type="button" class="settings-folder-toggle" aria-expanded="true">
                        <i class="bi bi-cpu-fill"></i>
                        <span>AI 与字幕</span>
                        <i class="bi bi-chevron-up ms-auto folder-caret"></i>
                    </button>
                    <div class="settings-folder-body nav flex-column nav-pills" role="tablist" aria-orientation="vertical">
                        <a class="nav-link" id="vtab-subtitle-tab" data-bs-toggle="pill" href="#vtab-subtitle" role="tab" aria-controls="vtab-subtitle" aria-selected="false">
                            <i class="bi bi-translate"></i> 字幕翻译
                        </a>
                        <a class="nav-link" id="vtab-asr-tab" data-bs-toggle="pill" href="#vtab-asr" role="tab" aria-controls="vtab-asr" aria-selected="false">
                            <i class="bi bi-mic"></i> 语音识别
                        </a>
                        <a class="nav-link" id="vtab-vad-tab" data-bs-toggle="pill" href="#vtab-vad" role="tab" aria-controls="vtab-vad" aria-selected="false">
                            <i class="bi bi-soundwave"></i> VAD检测
                        </a>
                        <a class="nav-link" id="vtab-openai-tab" data-bs-toggle="pill" href="#vtab-openai" role="tab" aria-controls="vtab-openai" aria-selected="false">
                            <i class="bi bi-robot"></i> OpenAI
                        </a>
                    </div>
                </div>

                <div class="settings-nav-folder" data-folder="security">
                    <button type="button" class="settings-folder-toggle" aria-expanded="true">
                        <i class="bi bi-shield-lock"></i>
                        <span>安全与合规</span>
                        <i class="bi bi-chevron-up ms-auto folder-caret"></i>
                    </button>
                    <div class="settings-folder-body nav flex-column nav-pills" role="tablist" aria-orientation="vertical">
                        <a class="nav-link" id="vtab-security-tab" data-bs-toggle="pill" href="#vtab-security" role="tab" aria-controls="vtab-security" aria-selected="false">
                            <i class="bi bi-lock"></i> 账号与安全
                        </a>
                        <a class="nav-link" id="vtab-aliyun-tab" data-bs-toggle="pill" href="#vtab-aliyun" role="tab" aria-controls="vtab-aliyun" aria-selected="false">
                            <i class="bi bi-shield-check"></i> 内容安全
                        </a>
                    </div>
                </div>

                <div class="settings-nav-folder" data-folder="monitoring">
                    <button type="button" class="settings-folder-toggle" aria-expanded="true">
                        <i class="bi bi-broadcast"></i>
                        <span>监控与扩展</span>
                        <i class="bi bi-chevron-up ms-auto folder-caret"></i>
                    </button>
                    <div class="settings-folder-body nav flex-column nav-pills" role="tablist" aria-orientation="vertical">
                        <a class="nav-link" id="vtab-ytmonitor-tab" data-bs-toggle="pill" href="#vtab-ytmonitor" role="tab" aria-controls="vtab-ytmonitor" aria-selected="false">
                            <i class="bi bi-youtube"></i> YouTube监控
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <form method="post" enctype="multipart/form-data">
                <div class="tab-content" id="settings-tabContent">
                    <!-- 通用设置 -->
                    <div class="tab-pane fade show active" id="vtab-general" role="tabpanel" aria-labelledby="vtab-general-tab">
                        <div class="settings-stack">

                            <section class="settings-section">
                                <div class="settings-section-header">
                                    <div>
                                        <h3 class="mb-1">自动化流程</h3>
                                        <p class="section-lead mb-0">控制无人值守流程与基础翻译能力，确保核心链路一键运行。</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="AUTO_MODE_ENABLED" {% if config.AUTO_MODE_ENABLED %}checked{% endif %}>
                                        启用无人值守自动投稿模式
                                    </label>
                                    <p class="help-text">自动完成从下载到投稿的全流程，无需人工干预</p>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="TRANSLATE_TITLE" {% if config.TRANSLATE_TITLE %}checked{% endif %}>
                                                自动翻译标题
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="TRANSLATE_DESCRIPTION" {% if config.TRANSLATE_DESCRIPTION %}checked{% endif %}>
                                                自动翻译描述
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="GENERATE_TAGS" {% if config.GENERATE_TAGS %}checked{% endif %}>
                                                自动生成标签
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="YOUTUBE_UPLOADER_AS_FIRST_TAG" {% if config.get('YOUTUBE_UPLOADER_AS_FIRST_TAG', False) %}checked{% endif %}>
                                                将YouTube上传者置于首标签
                                            </label>
                                            <p class="help-text">开启后会占用1个标签名额（最多6个标签）</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="RECOMMEND_PARTITION" {% if config.RECOMMEND_PARTITION %}checked{% endif %}>
                                                自动推荐分区
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section class="settings-section">
                                <div class="settings-section-header">
                                    <div>
                                        <h3 class="mb-1">投稿质量与安全</h3>
                                        <p class="section-lead mb-0">在质量与效率之间找到平衡，自动审核与封面策略一站式配置。</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="CONTENT_MODERATION_ENABLED" {% if config.CONTENT_MODERATION_ENABLED %}checked{% endif %}>
                                        启用内容审核
                                    </label>
                                    <p class="help-text">使用阿里云内容安全服务自动审核标题、描述和封面</p>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="cover-mode">封面处理模式:</label>
                                            <select name="COVER_PROCESSING_MODE" id="cover-mode" class="form-select">
                                                <option value="crop" {% if config.COVER_PROCESSING_MODE == 'crop' %}selected{% endif %}>裁剪模式 (保持清晰度)</option>
                                                <option value="pad" {% if config.COVER_PROCESSING_MODE == 'pad' %}selected{% endif %}>填充模式 (保持完整性)</option>
                                            </select>
                                            <p class="help-text">裁剪模式可能会裁掉封面边缘内容，填充模式会添加黑边</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="fixed-partition-id">固定分区ID（可选）:</label>
                                            <input type="text" id="fixed-partition-id" name="FIXED_PARTITION_ID" value="{{ config.get('FIXED_PARTITION_ID', '') }}" class="form-control" placeholder="如：123；留空则自动推荐">
                                            <p class="help-text">设置后将直接使用该分区ID，跳过自动推荐。</p>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section class="settings-section">
                                <div class="settings-section-header">
                                    <div>
                                        <h3 class="mb-1">工具与依赖</h3>
                                        <p class="section-lead mb-0">项目已内置 Windows/Linux 双平台 FFmpeg，可按需覆盖或自定义。</p>
                                    </div>
                                </div>
                                <div class="row g-3 align-items-start">
                                    <div class="col-md-6">
                                        <div class="form-group mb-0">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="FFMPEG_AUTO_DOWNLOAD" {% if config.get('FFMPEG_AUTO_DOWNLOAD', True) %}checked{% endif %}>
                                                Windows 缺失时允许联网补全 FFmpeg
                                            </label>
                                            <p class="help-text">默认使用仓库附带的 ffmpeg/ 目录，仅在 Windows 且文件缺失时才会尝试联网补齐。</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="ffmpeg-location">FFmpeg 自定义路径（可选）:</label>
                                            <input type="text" id="ffmpeg-location" name="FFMPEG_LOCATION" value="{{ config.get('FFMPEG_LOCATION', '') }}" class="form-control" placeholder="如：C:/tools/ffmpeg/bin/ffmpeg.exe 或留空">
                                            <p class="help-text">留空则默认使用项目根目录 ffmpeg/ 下的内置二进制。</p>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>

                    <!-- 账号与安全 -->
                    <div class="tab-pane fade" id="vtab-security" role="tabpanel" aria-labelledby="vtab-security-tab">
                        <div class="settings-section">
                            <h3><i class="bi bi-shield-lock"></i> 密码保护</h3>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="password_protection_enabled" id="password_protection_enabled" {% if config.password_protection_enabled %}checked{% endif %}>
                                    启用Web界面密码保护
                                </label>
                                <p class="help-text">启用后，访问Web界面需要输入密码。浏览器插件也将需要登录才能使用。</p>
                            </div>

                            <div id="password-fields">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="new_password">新密码:</label>
                                            <input type="password" id="new_password" name="new_password" class="form-control" autocomplete="new-password">
                                            <p class="help-text">设置或更改您的登录密码。如果留空，密码将不会被更改。</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="confirm_password">确认新密码:</label>
                                            <input type="password" id="confirm_password" name="confirm_password" class="form-control" autocomplete="new-password">
                                            <p class="help-text">请再次输入新密码。</p>
                                        </div>
                                    </div>
                                </div>
                                <div id="password-match-error" class="alert alert-danger mt-2 d-none">
                                    <i class="bi bi-exclamation-triangle"></i> 两次输入的密码不匹配。
                                </div>
                            </div>

                              <div class="row g-3 mt-1">
                                  <div class="col-md-6">
                                      <div class="form-group">
                                          <label for="login-max-attempts">最大连续错误次数（触发锁定）:</label>
                                          <input type="number" id="login-max-attempts" name="LOGIN_MAX_FAILED_ATTEMPTS" value="{{ config.get('LOGIN_MAX_FAILED_ATTEMPTS', 5) }}" min="1" max="20" class="form-control">
                                          <p class="help-text">连续密码错误达到该次数后，将临时锁定登录</p>
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="form-group">
                                          <label for="login-lock-minutes">锁定时长（分钟）:</label>
                                          <input type="number" id="login-lock-minutes" name="LOGIN_LOCKOUT_MINUTES" value="{{ config.get('LOGIN_LOCKOUT_MINUTES', 15) }}" min="1" max="1440" class="form-control">
                                          <p class="help-text">被锁定后需要等待的时间，默认15分钟</p>
                                      </div>
                                  </div>
                              </div>
                        </div>
                    </div>

                    <!-- 下载与代理（YouTube设置） -->
                    <div class="tab-pane fade" id="vtab-youtube" role="tabpanel" aria-labelledby="vtab-youtube-tab">
                        <div class="settings-section">
                            <h3>YouTube下载与代理</h3>

                            <div class="form-group">
                                <label for="youtube-cookies">YouTube Cookies文件路径:</label>
                                <input type="text" id="youtube-cookies" name="YOUTUBE_COOKIES_PATH" value="{{ config.YOUTUBE_COOKIES_PATH }}" class="form-control">
                                <p class="help-text">用于访问受限制的YouTube视频</p>
                            </div>

                            <div class="form-group">
                                <label for="youtube-cookies-file">上传新的YouTube Cookies文件:</label>
                                <input type="file" id="youtube-cookies-file" name="youtube_cookies_file" class="form-control">
                                <p class="help-text">上传新文件将覆盖原有文件</p>
                            </div>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="YOUTUBE_PROXY_ENABLED" {% if config.get('YOUTUBE_PROXY_ENABLED', False) %}checked{% endif %}>
                                    启用代理下载
                                </label>
                                <p class="help-text">在中国境内访问YouTube时通常需要代理</p>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="youtube-proxy-url">代理地址:</label>
                                        <input type="text" id="youtube-proxy-url" name="YOUTUBE_PROXY_URL" value="{{ config.get('YOUTUBE_PROXY_URL', '') }}" class="form-control" placeholder="http://127.0.0.1:7890 或 socks5://127.0.0.1:1080">
                                        <p class="help-text">支持HTTP和SOCKS5代理</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="youtube-download-threads">下载线程数:</label>
                                        <input type="number" id="youtube-download-threads" name="YOUTUBE_DOWNLOAD_THREADS" value="{{ config.get('YOUTUBE_DOWNLOAD_THREADS', 4) }}" min="1" max="16" class="form-control">
                                        <p class="help-text">建议1-8，过高可能被限速</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="youtube-proxy-username">代理用户名:</label>
                                        <input type="text" id="youtube-proxy-username" name="YOUTUBE_PROXY_USERNAME" value="{{ config.get('YOUTUBE_PROXY_USERNAME', '') }}" class="form-control" placeholder="可选">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="youtube-proxy-password">代理密码:</label>
                                        <input type="password" id="youtube-proxy-password" name="YOUTUBE_PROXY_PASSWORD" value="{{ config.get('YOUTUBE_PROXY_PASSWORD', '') }}" class="form-control" placeholder="可选">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="youtube-throttled-rate">下载速度限制:</label>
                                        <input type="text" id="youtube-throttled-rate" name="YOUTUBE_THROTTLED_RATE" value="{{ config.get('YOUTUBE_THROTTLED_RATE', '') }}" class="form-control" placeholder="如：1M、500K、2.5M">
                                        <p class="help-text">限制下载速度以避免被限流，留空不限制</p>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong class="ms-1">YouTube下载设置说明</strong>
                                <ul class="mb-0 mt-2">
                                    <li>HTTP代理：http://服务器地址:端口 (如：http://127.0.0.1:7890)</li>
                                    <li>SOCKS5代理：socks5://服务器地址:端口 (如：socks5://127.0.0.1:1080)</li>
                                    <li>线程数过高可能触发反爬虫；可配合速度限制避免限流</li>
                                </ul>
                            </div>

                            <div class="settings-section">
                                <h3>下载内容清理设置</h3>

                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="DOWNLOAD_CLEANUP_ENABLED" {% if config.get('DOWNLOAD_CLEANUP_ENABLED', False) %}checked{% endif %}>
                                        启用自动下载内容清理
                                    </label>
                                    <p class="help-text">定期自动清理旧的下载文件</p>
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="download-cleanup-hours">保留下载内容小时数:</label>
                                            <input type="number" id="download-cleanup-hours" name="DOWNLOAD_CLEANUP_HOURS" value="{{ config.get('DOWNLOAD_CLEANUP_HOURS', 72) }}" min="1" max="17520" class="form-control">
                                            <p class="help-text">默认保留30天（720小时）</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="download-cleanup-interval">清理间隔(小时):</label>
                                            <input type="number" id="download-cleanup-interval" name="DOWNLOAD_CLEANUP_INTERVAL" value="{{ config.get('DOWNLOAD_CLEANUP_INTERVAL', 24) }}" min="1" max="168" class="form-control">
                                            <p class="help-text">每隔多少小时执行清理</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
                                    <button type="button" id="manual-download-cleanup-btn" class="btn btn-warning">
                                        <i class="bi bi-trash"></i> 按时间清理下载内容
                                    </button>
                                    <span class="help-text">将删除 <span class="text-primary">{{ config.get('DOWNLOAD_CLEANUP_HOURS', 72) }}</span> 小时前的下载文件</span>
                                </div>

                                <div class="alert alert-info mt-3">
                                    <i class="bi bi-info-circle"></i>
                                    <strong class="ms-1">下载内容清理说明</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>清理将删除指定时间前的所有下载文件和目录</li>
                                        <li>包括视频文件、音频文件、字幕文件、封面图片等</li>
                                        <li>建议根据磁盘空间情况设置合适的保留时间</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AcFun账号设置 -->
                    <div class="tab-pane fade" id="vtab-acfun" role="tabpanel" aria-labelledby="vtab-acfun-tab">
                        <div class="settings-section">
                            <h3>AcFun账号设置</h3>

                            <div class="form-group">
                                <label for="acfun-cookies">AcFun Cookies文件路径:</label>
                                <input type="text" id="acfun-cookies" name="ACFUN_COOKIES_PATH" value="{{ config.ACFUN_COOKIES_PATH }}" class="form-control">
                                <p class="help-text">推荐使用Cookie登录，支持Netscape和JSON格式</p>
                            </div>

                            <div class="form-group">
                                <label for="acfun-cookies-file">上传新的AcFun Cookies文件:</label>
                                <input type="file" id="acfun-cookies-file" name="acfun_cookies_file" class="form-control">
                                <p class="help-text">上传新文件将覆盖原有文件。Cookie优先级高于用户名密码</p>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="acfun-username">AcFun用户名（备用）:</label>
                                        <input type="text" id="acfun-username" name="ACFUN_USERNAME" value="{{ config.ACFUN_USERNAME }}" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="acfun-password">AcFun密码（备用）:</label>
                                        <input type="password" id="acfun-password" name="ACFUN_PASSWORD" value="{{ config.ACFUN_PASSWORD }}" class="form-control">
                                        <p class="help-text">密码仅用于自动登录，不会被发送到其它地方</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 字幕翻译设置 -->
                    <div class="tab-pane fade" id="vtab-subtitle" role="tabpanel" aria-labelledby="vtab-subtitle-tab">
                        <div class="settings-stack">
                            <section class="settings-section">
                                <div class="settings-section-header">
                                    <div>
                                        <h3 class="mb-1">字幕后处理与格式</h3>
                                        <p class="section-lead mb-0">统一时间轴、控制粒度，减少碎片字幕，提升观感。</p>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="subtitle-time-offset">全局时间偏移(秒):</label>
                                            <input type="number" step="0.1" id="subtitle-time-offset" name="SUBTITLE_TIME_OFFSET_S" value="{{ config.get('SUBTITLE_TIME_OFFSET_S', 0.0) }}" class="form-control">
                                            <p class="help-text">可为负数：整体提前或延后字幕（如 -0.5 提前半秒）</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="subtitle-min-cue-dur">最短字幕时长(秒):</label>
                                            <input type="number" step="0.1" min="0" id="subtitle-min-cue-dur" name="SUBTITLE_MIN_CUE_DURATION_S" value="{{ config.get('SUBTITLE_MIN_CUE_DURATION_S', 0.6) }}" class="form-control">
                                            <p class="help-text">短于该时长的字幕将尝试延长或与相邻合并</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="subtitle-merge-gap">合并间隙(秒):</label>
                                            <input type="number" step="0.05" min="0" id="subtitle-merge-gap" name="SUBTITLE_MERGE_GAP_S" value="{{ config.get('SUBTITLE_MERGE_GAP_S', 0.3) }}" class="form-control">
                                            <p class="help-text">相邻字幕间隙 ≤ 该值时自动合并</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="subtitle-min-text-len">最小文本长度(字符):</label>
                                            <input type="number" min="0" step="1" id="subtitle-min-text-len" name="SUBTITLE_MIN_TEXT_LENGTH" value="{{ config.get('SUBTITLE_MIN_TEXT_LENGTH', 2) }}" class="form-control">
                                            <p class="help-text">长度低于该值的字幕会尝试合并或被丢弃</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="subtitle-max-line-length">每行最大字符数:</label>
                                            <input type="number" min="10" max="200" step="1" id="subtitle-max-line-length" name="SUBTITLE_MAX_LINE_LENGTH" value="{{ config.get('SUBTITLE_MAX_LINE_LENGTH', 42) }}" class="form-control">
                                            <p class="help-text">超过会按标点/空格自动拆分</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="subtitle-max-lines">单条字幕最大行数:</label>
                                            <input type="number" min="1" max="5" step="1" id="subtitle-max-lines" name="SUBTITLE_MAX_LINES" value="{{ config.get('SUBTITLE_MAX_LINES', 2) }}" class="form-control">
                                            <p class="help-text">控制单条字幕的垂直高度，常用 2 行</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="SUBTITLE_NORMALIZE_PUNCTUATION" {% if config.get('SUBTITLE_NORMALIZE_PUNCTUATION', True) %}checked{% endif %}>
                                                标准化标点与空白
                                            </label>
                                            <p class="help-text">保证标点后统一空格，清理多余空白字符</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="SUBTITLE_FILTER_FILLER_WORDS" {% if config.get('SUBTITLE_FILTER_FILLER_WORDS', False) %}checked{% endif %}>
                                                过滤填充词(um/uh/嗯/啊)
                                            </label>
                                            <p class="help-text">去除语气词可减少噪声，对口语内容效果明显</p>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section class="settings-section">
                                <div class="settings-section-header">
                                    <div>
                                        <h3 class="mb-1">字幕翻译设置</h3>
                                        <p class="section-lead mb-0">配置翻译语种、重试策略及嵌入选项。</p>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="SUBTITLE_TRANSLATION_ENABLED" {% if config.SUBTITLE_TRANSLATION_ENABLED %}checked{% endif %}>
                                        启用字幕翻译
                                    </label>
                                    <p class="help-text">自动翻译YouTube视频字幕</p>
                                </div>

                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="SUBTITLE_QC_ENABLED" {% if config.get('SUBTITLE_QC_ENABLED', False) %}checked{% endif %}>
                                        启用最终字幕质检（QC）
                                    </label>
                                    <p class="help-text">翻译/生成字幕后会抽样送检；若判定字幕异常：不烧录字幕，但保留字幕文件并继续上传原视频，同时任务列表标记“字幕异常”。</p>
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="subtitle-qc-threshold">通过阈值(0-1):</label>
                                            <input type="number" step="0.05" min="0" max="1" id="subtitle-qc-threshold" name="SUBTITLE_QC_THRESHOLD" value="{{ config.get('SUBTITLE_QC_THRESHOLD', 0.6) }}" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="subtitle-qc-sample">抽样条目数:</label>
                                            <input type="number" min="10" max="300" step="1" id="subtitle-qc-sample" name="SUBTITLE_QC_SAMPLE_MAX_ITEMS" value="{{ config.get('SUBTITLE_QC_SAMPLE_MAX_ITEMS', 80) }}" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="subtitle-qc-maxchars">送检最大字符数:</label>
                                            <input type="number" min="1000" max="30000" step="500" id="subtitle-qc-maxchars" name="SUBTITLE_QC_MAX_CHARS" value="{{ config.get('SUBTITLE_QC_MAX_CHARS', 9000) }}" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="subtitle-qc-model">QC模型名(可选):</label>
                                            <input type="text" id="subtitle-qc-model" name="SUBTITLE_QC_MODEL_NAME" value="{{ config.get('SUBTITLE_QC_MODEL_NAME', '') }}" class="form-control" placeholder="留空=复用字幕翻译模型">
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="subtitle-source-lang">源语言:</label>
                                            <select name="SUBTITLE_SOURCE_LANGUAGE" id="subtitle-source-lang" class="form-select">
                                                <option value="auto" {% if config.SUBTITLE_SOURCE_LANGUAGE == 'auto' %}selected{% endif %}>自动检测</option>
                                                <option value="en" {% if config.SUBTITLE_SOURCE_LANGUAGE == 'en' %}selected{% endif %}>英语</option>
                                                <option value="ja" {% if config.SUBTITLE_SOURCE_LANGUAGE == 'ja' %}selected{% endif %}>日语</option>
                                                <option value="ko" {% if config.SUBTITLE_SOURCE_LANGUAGE == 'ko' %}selected{% endif %}>韩语</option>
                                                <option value="zh" {% if config.SUBTITLE_SOURCE_LANGUAGE == 'zh' %}selected{% endif %}>中文</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="subtitle-target-lang">目标语言:</label>
                                            <select name="SUBTITLE_TARGET_LANGUAGE" id="subtitle-target-lang" class="form-select">
                                                <option value="zh" {% if config.SUBTITLE_TARGET_LANGUAGE == 'zh' %}selected{% endif %}>中文</option>
                                                <option value="en" {% if config.SUBTITLE_TARGET_LANGUAGE == 'en' %}selected{% endif %}>英语</option>
                                                <option value="ja" {% if config.SUBTITLE_TARGET_LANGUAGE == 'ja' %}selected{% endif %}>日语</option>
                                                <option value="ko" {% if config.SUBTITLE_TARGET_LANGUAGE == 'ko' %}selected{% endif %}>韩语</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="subtitle-batch-size">批次大小:</label>
                                            <input type="number" id="subtitle-batch-size" name="SUBTITLE_BATCH_SIZE" value="{{ config.SUBTITLE_BATCH_SIZE }}" min="1" max="20" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="subtitle-max-retries">最大重试次数:</label>
                                            <input type="number" id="subtitle-max-retries" name="SUBTITLE_MAX_RETRIES" value="{{ config.SUBTITLE_MAX_RETRIES }}" min="1" max="10" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="subtitle-retry-delay">重试延迟(秒):</label>
                                            <input type="number" id="subtitle-retry-delay" name="SUBTITLE_RETRY_DELAY" value="{{ config.SUBTITLE_RETRY_DELAY }}" min="1" max="30" class="form-control">
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="SUBTITLE_EMBED_IN_VIDEO" {% if config.SUBTITLE_EMBED_IN_VIDEO %}checked{% endif %}>
                                                将字幕嵌入视频
                                            </label>
                                            <p class="help-text">使用FFmpeg将翻译后的字幕硬编码到视频中</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 视频转码参数设置 -->
                                <h5 class="mt-4 mb-3"><i class="bi bi-gpu-card"></i> 视频转码参数</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="video-encoder">视频编码器:</label>
                                            <select id="video-encoder" name="VIDEO_ENCODER" class="form-select">
                                                <option value="auto" {% if config.get('VIDEO_ENCODER', 'auto') == 'auto' %}selected{% endif %}>自动检测</option>
                                                <option value="cpu" {% if config.get('VIDEO_ENCODER') == 'cpu' %}selected{% endif %}>CPU (libx264)</option>
                                                <option value="nvidia" {% if config.get('VIDEO_ENCODER') == 'nvidia' %}selected{% endif %}>NVIDIA (NVENC)</option>
                                                <option value="intel" {% if config.get('VIDEO_ENCODER') == 'intel' %}selected{% endif %}>Intel (QSV)</option>
                                                <option value="amd" {% if config.get('VIDEO_ENCODER') == 'amd' %}selected{% endif %}>AMD (AMF/VAAPI)</option>
                                            </select>
                                            <p class="help-text">选择"自动检测"将优先使用可用的硬件编码器，无可用硬件时回退到CPU。</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="video-preset">编码速度预设:</label>
                                            <select id="video-preset" name="VIDEO_PRESET" class="form-select">
                                                <option value="ultrafast" {% if config.get('VIDEO_PRESET') == 'ultrafast' %}selected{% endif %}>ultrafast (最快，质量最低)</option>
                                                <option value="superfast" {% if config.get('VIDEO_PRESET') == 'superfast' %}selected{% endif %}>superfast</option>
                                                <option value="veryfast" {% if config.get('VIDEO_PRESET') == 'veryfast' %}selected{% endif %}>veryfast</option>
                                                <option value="faster" {% if config.get('VIDEO_PRESET') == 'faster' %}selected{% endif %}>faster</option>
                                                <option value="fast" {% if config.get('VIDEO_PRESET') == 'fast' %}selected{% endif %}>fast</option>
                                                <option value="medium" {% if config.get('VIDEO_PRESET', 'medium') == 'medium' %}selected{% endif %}>medium (推荐)</option>
                                                <option value="slow" {% if config.get('VIDEO_PRESET') == 'slow' %}selected{% endif %}>slow</option>
                                                <option value="slower" {% if config.get('VIDEO_PRESET') == 'slower' %}selected{% endif %}>slower</option>
                                                <option value="veryslow" {% if config.get('VIDEO_PRESET') == 'veryslow' %}selected{% endif %}>veryslow (最慢，质量最高)</option>
                                            </select>
                                            <p class="help-text">速度越慢，相同码率下画质越好。硬件编码时会自动映射到对应的预设。</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="video-crf">视频质量 (CRF):</label>
                                            <input type="number" id="video-crf" name="VIDEO_CRF" value="{{ config.get('VIDEO_CRF', 23) }}" min="0" max="51" step="1" class="form-control">
                                            <p class="help-text">CRF值越小质量越高（推荐18-28），0为无损。硬件编码会自动映射到对应的质量参数。</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="video-bitrate">视频比特率 (可选):</label>
                                            <input type="text" id="video-bitrate" name="VIDEO_BITRATE" value="{{ config.get('VIDEO_BITRATE', '') }}" class="form-control" placeholder="例如: 8M, 5000k">
                                            <p class="help-text">指定固定比特率（如"8M"、"5000k"）。设置后CRF失效。留空使用CRF模式。</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-info mt-3">
                                    <i class="bi bi-info-circle"></i> <strong>GPU编码说明：</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Docker用户：</strong>需配置GPU穿透，详见 docker-compose.yml 中的注释说明</li>
                                        <li><strong>NVIDIA：</strong>需安装 NVIDIA 驱动（支持 NVENC）</li>
                                        <li><strong>Intel：</strong>需安装 Intel Media SDK 或 oneVPL</li>
                                        <li><strong>AMD (Windows)：</strong>需安装 AMD 驱动及 AMF 组件</li>
                                        <li><strong>AMD (Linux)：</strong>使用 VAAPI，需安装 mesa-va-drivers</li>
                                    </ul>
                                </div>

                                <div class="row g-3 mt-1">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="subtitle-api-provider">API提供商:</label>
                                            <select id="subtitle-api-provider" name="SUBTITLE_API_PROVIDER" class="form-select">
                                                <option value="openai" {% if config.get('SUBTITLE_API_PROVIDER', 'openai') == 'openai' %}selected{% endif %}>OpenAI兼容</option>
                                            </select>
                                            <p class="help-text">当前仅支持 OpenAI 兼容接口，后续可扩展。</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="SUBTITLE_KEEP_ORIGINAL" {% if config.SUBTITLE_KEEP_ORIGINAL %}checked{% endif %}>
                                                保留原始字幕文件
                                            </label>
                                            <p class="help-text">保留原始和翻译后的字幕文件</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="subtitleMaxWorkers" class="form-label">最大并发线程数</label>
                                            <input type="number" class="form-control" id="subtitleMaxWorkers" name="SUBTITLE_MAX_WORKERS" value="{{ config.get('SUBTITLE_MAX_WORKERS', 0) }}" min="0" step="1" inputmode="numeric" pattern="[0-9]*">
                                            <div class="form-text">设置字幕翻译的并发线程数；设置为 <strong>0</strong> 表示不设上限，按任务量动态分配</div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>

                    <!-- 语音识别（无字幕转写）设置 -->
                    <div class="tab-pane fade" id="vtab-asr" role="tabpanel" aria-labelledby="vtab-asr-tab">
                        <div class="settings-section">
                            <h3>语音识别（无字幕转写）</h3>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="SPEECH_RECOGNITION_ENABLED" {% if config.get('SPEECH_RECOGNITION_ENABLED', False) %}checked{% endif %}>
                                    启用语音识别生成字幕（Whisper API）
                                </label>
                                <p class="help-text">当yt-dlp未能获取到字幕时，使用Whisper将音频自动转写为SRT字幕，再配合字幕翻译功能形成完整链路。</p>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="asr-provider">识别提供商:</label>
                                        <select id="asr-provider" name="SPEECH_RECOGNITION_PROVIDER" class="form-select">
                                            <option value="whisper" {% if config.get('SPEECH_RECOGNITION_PROVIDER', 'whisper') == 'whisper' %}selected{% endif %}>Whisper（OpenAI兼容）</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="SPEECH_RECOGNITION_MIN_SUBTITLE_LINES_ENABLED" {% if config.get('SPEECH_RECOGNITION_MIN_SUBTITLE_LINES_ENABLED', True) %}checked{% endif %}>
                                            少于最小字幕条目数则视为无字幕
                                        </label>
                                        <p class="help-text">用于过滤误识别或噪声结果。默认开启。</p>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="asr-min-lines">最小字幕条目数:</label>
                                        <input type="number" id="asr-min-lines" name="SPEECH_RECOGNITION_MIN_SUBTITLE_LINES" value="{{ config.get('SPEECH_RECOGNITION_MIN_SUBTITLE_LINES', 5) }}" min="0" max="1000" class="form-control">
                                        <p class="help-text">当ASR生成的字幕条目数小于该值时，将当作“没有字幕”处理（不会进入翻译/烧录）。</p>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="whisper-api-key">Whisper API Key（可选）:</label>
                                        <input type="password" id="whisper-api-key" name="WHISPER_API_KEY" value="{{ config.get('WHISPER_API_KEY', '') }}" class="form-control" placeholder="留空沿用上方 OpenAI Key">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="whisper-model">Whisper模型名:</label>
                                        <input type="text" id="whisper-model" name="WHISPER_MODEL_NAME" value="{{ config.get('WHISPER_MODEL_NAME', 'whisper-1') }}" class="form-control" placeholder="如 whisper-1 / gpt-4o-transcribe">
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        <label for="whisper-base-url">Whisper Base URL（可选）:</label>
                                        <input type="text" id="whisper-base-url" name="WHISPER_BASE_URL" value="{{ config.get('WHISPER_BASE_URL', '') }}" class="form-control" placeholder="留空沿用 OpenAI Base URL">
                                    </div>
                                </div>
                            </div>
                            <div class="settings-section mt-3">
                                <h3>Whisper 高级参数</h3>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="whisper-language">强制语言(可选):</label>
                                            <input type="text" id="whisper-language" name="WHISPER_LANGUAGE" value="{{ config.get('WHISPER_LANGUAGE', '') }}" class="form-control" placeholder="如 en/zh/ja，留空自动检测" list="whisper-language-list">
                                            <datalist id="whisper-language-list">
                                                {% for lang in whisper_languages or [] %}
                                                <option value="{{ lang.code }}">{{ lang.name }} ({{ lang.code }})</option>
                                                {% endfor %}
                                            </datalist>
                                            <p class="help-text">支持的语言已与 Whisper 官方列表同步，留空则自动检测。</p>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="whisper-prompt">提示词(可选):</label>
                                            <input type="text" id="whisper-prompt" name="WHISPER_PROMPT" value="{{ config.get('WHISPER_PROMPT', '') }}" class="form-control" placeholder="引导模型避免幻觉，如：Technical interview">
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="WHISPER_TRANSLATE" {% if config.get('WHISPER_TRANSLATE', False) %}checked{% endif %}> 翻译为英文
                                            </label>
                                            <p class="help-text">开启后输出英文而非原语言。</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="whisper-max-workers">并发处理数:</label>
                                            <input type="number" min="1" step="1" id="whisper-max-workers" name="WHISPER_MAX_WORKERS" value="{{ config.get('WHISPER_MAX_WORKERS', 3) }}" class="form-control">
                                            <p class="help-text">预留，当前顺序处理。</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="whisper-max-retries">最大重试次数:</label>
                                            <input type="number" min="1" step="1" id="whisper-max-retries" name="WHISPER_MAX_RETRIES" value="{{ config.get('WHISPER_MAX_RETRIES', 3) }}" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="whisper-retry-delay">初始重试延迟(秒):</label>
                                            <input type="number" min="0" step="0.1" id="whisper-retry-delay" name="WHISPER_RETRY_DELAY_S" value="{{ config.get('WHISPER_RETRY_DELAY_S', 2.0) }}" class="form-control">
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="audio-chunk-window">分片窗口时长(秒):</label>
                                            <input type="number" min="5" step="0.5" id="audio-chunk-window" name="AUDIO_CHUNK_WINDOW_S" value="{{ config.get('AUDIO_CHUNK_WINDOW_S', 25.0) }}" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="audio-chunk-overlap">分片重叠(秒):</label>
                                            <input type="number" min="0" step="0.05" id="audio-chunk-overlap" name="AUDIO_CHUNK_OVERLAP_S" value="{{ config.get('AUDIO_CHUNK_OVERLAP_S', 0.2) }}" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="WHISPER_FALLBACK_TO_FIXED_CHUNKS" {% if config.get('WHISPER_FALLBACK_TO_FIXED_CHUNKS', True) %}checked{% endif %}> VAD失败时回退到固定窗口
                                            </label>
                                            <p class="help-text">当语音活动检测接口异常或无片段时仍尝试完整转写。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VAD 设置 -->
                    <div class="tab-pane fade" id="vtab-vad" role="tabpanel" aria-labelledby="vtab-vad-tab">
                        <div class="settings-section">
                            <h3>语音活动检测（VAD）</h3>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="VAD_ENABLED" {% if config.get('VAD_ENABLED', False) %}checked{% endif %}>
                                    启用VAD语音段检测
                                </label>
                                <p class="help-text">在调用Whisper前先检测语音段，过滤长静音可有效降低“幻觉”内容。</p>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="vad-provider">VAD提供商:</label>
                                        <select id="vad-provider" name="VAD_PROVIDER" class="form-select">
                                            <option value="silero-vad" {% if config.get('VAD_PROVIDER', 'silero-vad') == 'silero-vad' %}selected{% endif %}>Silero VAD</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="vad-api-url">API地址:</label>
                                        <input type="text" id="vad-api-url" name="VAD_API_URL" value="{{ config.get('VAD_API_URL', 'http://localhost:8080/vad') }}" class="form-control" placeholder="http://192.168.x.x:8080/vad">
                                        <p class="help-text">填写VAD接口地址。</p>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="vad-api-token">API鉴权Token（可选）:</label>
                                        <input type="password" id="vad-api-token" name="VAD_API_TOKEN" value="{{ config.get('VAD_API_TOKEN', '') }}" class="form-control" placeholder="sk-xxx">
                                        <p class="help-text">如未开启鉴权可留空。</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="vad-threshold">语音触发阈值:</label>
                                        <input type="number" step="0.01" min="0" max="1" id="vad-threshold" name="VAD_SILERO_THRESHOLD" value="{{ config.get('VAD_SILERO_THRESHOLD', 0.5) }}" class="form-control">
                                        <p class="help-text">范围0-1，数值越大越严格，默认0.5。</p>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="vad-min-speech">最短语音时长(ms):</label>
                                        <input type="number" id="vad-min-speech" name="VAD_SILERO_MIN_SPEECH_MS" value="{{ config.get('VAD_SILERO_MIN_SPEECH_MS', 250) }}" min="0" class="form-control">
                                        <p class="help-text">短于该时长的片段会被忽略。</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="vad-min-silence">最短静音时长(ms):</label>
                                        <input type="number" id="vad-min-silence" name="VAD_SILERO_MIN_SILENCE_MS" value="{{ config.get('VAD_SILERO_MIN_SILENCE_MS', 100) }}" min="0" class="form-control">
                                        <p class="help-text">用于欠采样环境的降噪策略。</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="vad-pad-ms">语音两侧留白(ms):</label>
                                        <input type="number" id="vad-pad-ms" name="VAD_SILERO_SPEECH_PAD_MS" value="{{ config.get('VAD_SILERO_SPEECH_PAD_MS', 30) }}" min="0" class="form-control">
                                        <p class="help-text">适当留白可避免截断单词。</p>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="vad-max-speech">单段最长语音(s):</label>
                                        <input type="number" id="vad-max-speech" name="VAD_SILERO_MAX_SPEECH_S" value="{{ config.get('VAD_SILERO_MAX_SPEECH_S', 120) }}" min="1" class="form-control">
                                        <p class="help-text">过长片段将被自动截断。</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="vad-max-segment">Whisper分段上限(s):</label>
                                        <input type="number" id="vad-max-segment" name="VAD_MAX_SEGMENT_S" value="{{ config.get('VAD_MAX_SEGMENT_S', 90) }}" min="10" class="form-control">
                                        <p class="help-text">用于拼接VAD片段时的最大长度，超过会再次拆分。</p>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-section mt-3">
                                <h3>VAD 后处理约束</h3>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="vad-merge-gap">合并间隙阈值(秒):</label>
                                            <input type="number" step="0.05" min="0" id="vad-merge-gap" name="VAD_MERGE_GAP_S" value="{{ config.get('VAD_MERGE_GAP_S', 0.25) }}" class="form-control">
                                            <p class="help-text">间隙小于该值的相邻段会合并。</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="vad-min-segment">最短片段时长(秒):</label>
                                            <input type="number" step="0.1" min="0" id="vad-min-segment" name="VAD_MIN_SEGMENT_S" value="{{ config.get('VAD_MIN_SEGMENT_S', 1.0) }}" class="form-control">
                                            <p class="help-text">短于该值的片段将尝试与前后合并。</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="vad-max-split">二次切分上限(秒):</label>
                                            <input type="number" step="0.5" min="1" id="vad-max-split" name="VAD_MAX_SEGMENT_S_FOR_SPLIT" value="{{ config.get('VAD_MAX_SEGMENT_S_FOR_SPLIT', 8.0) }}" class="form-control">
                                            <p class="help-text">超过该时长的长段会按规则再次拆分。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>

                    <!-- 并发与日志 -->
                    <div class="tab-pane fade" id="vtab-concurrency" role="tabpanel" aria-labelledby="vtab-concurrency-tab">
                        <div class="settings-section">
                            <h3>任务并发控制</h3>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="max-concurrent-tasks">最大并发任务数:</label>
                                        <input type="number" id="max-concurrent-tasks" name="MAX_CONCURRENT_TASKS" value="{{ config.get('MAX_CONCURRENT_TASKS', 2) }}" min="1" max="10" class="form-control">
                                        <p class="help-text">同时处理的最大任务数量（包括下载、翻译等操作），推荐2个以平衡性能与内存使用</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="max-concurrent-uploads">最大并发上传数:</label>
                                        <input type="number" id="max-concurrent-uploads" name="MAX_CONCURRENT_UPLOADS" value="{{ config.get('MAX_CONCURRENT_UPLOADS', 1) }}" min="1" max="5" class="form-control">
                                        <p class="help-text">同时上传到AcFun的最大视频数量，建议设置为1</p>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong class="ms-1">并发控制说明</strong>
                                <ul class="mb-0 mt-2">
                                    <li>任务并发：控制整体任务处理的并发数，影响系统资源使用（推荐2个）</li>
                                    <li>上传并发：控制同时上传到AcFun的视频数，建议设置为1</li>
                                    <li>推荐配置：任务并发2，上传并发1（平衡性能与内存使用）</li>
                                    <li>内存优化：系统会在高内存使用时自动降低并发数</li>
                                </ul>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>日志清理设置</h3>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="LOG_CLEANUP_ENABLED" {% if config.LOG_CLEANUP_ENABLED %}checked{% endif %}>
                                    启用自动日志清理
                                </label>
                                <p class="help-text">定期自动清理旧日志文件</p>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="log-cleanup-hours">保留日志小时数:</label>
                                        <input type="number" id="log-cleanup-hours" name="LOG_CLEANUP_HOURS" value="{{ config.LOG_CLEANUP_HOURS }}" min="1" max="8760" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="log-cleanup-interval">清理间隔(小时):</label>
                                        <input type="number" id="log-cleanup-interval" name="LOG_CLEANUP_INTERVAL" value="{{ config.LOG_CLEANUP_INTERVAL }}" min="1" max="168" class="form-control">
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
                                <button type="button" id="manual-cleanup-btn" class="btn btn-warning">
                                    <i class="bi bi-trash"></i> 按时间清理日志
                                </button>
                                <span class="help-text">将删除 <span class="text-primary">{{ config.LOG_CLEANUP_HOURS }}</span> 小时前的日志文件</span>
                            </div>

                            <div class="mt-3">
                                <button type="button" id="clear-logs-btn" class="btn btn-danger">
                                    <i class="bi bi-trash-fill"></i> 立即清空日志
                                </button>
                                <button type="button" id="confirm-clear-btn" class="btn btn-outline-danger ms-2 d-none">
                                    <i class="bi bi-check-lg"></i> 确认清空
                                </button>
                                <button type="button" id="cancel-clear-btn" class="btn btn-outline-secondary ms-2 d-none">
                                    <i class="bi bi-x-lg"></i> 取消
                                </button>
                                <p class="help-text mt-2">立即清空 task_manager.log、app.log 内容并删除所有 task_xxx.log 文件</p>
                                <div id="clear-warning" class="alert alert-warning mt-2 d-none">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>警告：</strong>此操作将立即清空所有日志文件，无法恢复！<br>
                                    将执行以下操作：<br>
                                    • 清空 task_manager.log 和 app.log 的内容<br>
                                    • 删除所有 task_xxx.log 文件<br>
                                    <strong>确定要继续吗？</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- OpenAI 设置 -->
                    <div class="tab-pane fade" id="vtab-openai" role="tabpanel" aria-labelledby="vtab-openai-tab">
                        <div class="settings-section">
                            <h3>OpenAI API设置</h3>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="openai-key">OpenAI API Key:</label>
                                        <input type="password" id="openai-key" name="OPENAI_API_KEY" value="{{ config.OPENAI_API_KEY }}" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="openai-model">OpenAI模型:</label>
                                        <input type="text" id="openai-model" name="OPENAI_MODEL_NAME" value="{{ config.OPENAI_MODEL_NAME }}" class="form-control" placeholder="如 gpt-3.5-turbo / gpt-4">
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        <label for="openai-url">OpenAI API Base URL:</label>
                                        <input type="text" id="openai-url" name="OPENAI_BASE_URL" value="{{ config.OPENAI_BASE_URL }}" class="form-control">
                                        <p class="help-text">可设置为国内中转API或官方API</p>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        <label for="subtitle-openai-url">字幕翻译专用 Base URL（可选）:</label>
                                        <input type="text" id="subtitle-openai-url" name="SUBTITLE_OPENAI_BASE_URL" value="{{ config.get('SUBTITLE_OPENAI_BASE_URL', '') }}" class="form-control" placeholder="留空则与上方一致">
                                        <p class="help-text">留空时使用上方的 Base URL。填写后，字幕翻译将走该地址，视频信息翻译/标签/分区仍走上方地址。</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="subtitle-openai-key">字幕翻译专用 API Key（可选）:</label>
                                        <input type="password" id="subtitle-openai-key" name="SUBTITLE_OPENAI_API_KEY" value="{{ config.get('SUBTITLE_OPENAI_API_KEY', '') }}" class="form-control" placeholder="留空沿用通用Key">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="subtitle-openai-model">字幕翻译专用模型名（可选）:</label>
                                        <input type="text" id="subtitle-openai-model" name="SUBTITLE_OPENAI_MODEL_NAME" value="{{ config.get('SUBTITLE_OPENAI_MODEL_NAME', '') }}" class="form-control" placeholder="留空沿用通用模型名">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 内容安全（阿里云） -->
                    <div class="tab-pane fade" id="vtab-aliyun" role="tabpanel" aria-labelledby="vtab-aliyun-tab">
                        <div class="settings-section">
                            <h3>阿里云内容安全设置</h3>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="aliyun-key">阿里云AccessKey ID:</label>
                                        <input type="password" id="aliyun-key" name="ALIYUN_ACCESS_KEY_ID" value="{{ config.ALIYUN_ACCESS_KEY_ID }}" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="aliyun-secret">阿里云AccessKey Secret:</label>
                                        <input type="password" id="aliyun-secret" name="ALIYUN_ACCESS_KEY_SECRET" value="{{ config.ALIYUN_ACCESS_KEY_SECRET }}" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="aliyun-region">阿里云区域:</label>
                                        <input type="text" id="aliyun-region" name="ALIYUN_CONTENT_MODERATION_REGION" value="{{ config.ALIYUN_CONTENT_MODERATION_REGION }}" class="form-control" placeholder="默认 cn-shanghai">
                                        <p class="help-text">默认为 cn-shanghai</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="aliyun-text-service">文本审核服务类型:</label>
                                        <input type="text" id="aliyun-text-service" name="ALIYUN_TEXT_MODERATION_SERVICE" value="{{ config.ALIYUN_TEXT_MODERATION_SERVICE }}" class="form-control" placeholder="如 comment_detection, ugc_moderation_byllm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- YouTube 监控设置 -->
                    <div class="tab-pane fade" id="vtab-ytmonitor" role="tabpanel" aria-labelledby="vtab-ytmonitor-tab">
                        <div class="settings-section">
                            <h3><i class="bi bi-youtube text-danger"></i> YouTube监控设置</h3>

                            <div class="form-group">
                                <label for="youtube-api-key">YouTube Data API v3 密钥:</label>
                                <input type="password" id="youtube-api-key" name="YOUTUBE_API_KEY" value="{{ config.YOUTUBE_API_KEY }}" class="form-control">
                                <p class="help-text">
                                    请在 <a href="https://console.developers.google.com/" target="_blank" rel="noopener">Google Cloud Console</a> 获取API密钥。
                                    配置后可在 <a href="{{ url_for('youtube_monitor_index') }}">YouTube监控</a> 页面使用自动监控功能。
                                </p>
                            </div>

                            {% if config.YOUTUBE_API_KEY %}
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> YouTube API密钥已配置，监控功能可正常使用
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> 尚未配置YouTube API密钥，请先设置才能使用监控功能
                            </div>
                            {% endif %}

                            <div class="alert alert-info">
                                <strong><i class="bi bi-info-circle"></i> 使用说明：</strong>
                                <ul class="mb-0 mt-2">
                                    <li>1. 访问 <a href="https://console.developers.google.com/" target="_blank" rel="noopener">Google Cloud Console</a></li>
                                    <li>2. 创建项目并启用 YouTube Data API v3</li>
                                    <li>3. 创建API密钥并设置适当的限制</li>
                                    <li>4. 将密钥填入上方输入框并保存</li>
                                    <li>5. 前往 <a href="{{ url_for('youtube_monitor_index') }}">YouTube监控</a> 页面配置监控任务</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-actions-bar">
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" id="reset-settings-btn" class="btn btn-outline-secondary">重置</button>
                        <button type="submit" class="btn btn-primary">保存设置</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 独立的日志清理表单 -->
    <form method="post" action="{{ url_for('cleanup_logs_route') }}" class="d-none" id="cleanup-form">
        <input type="hidden" name="hours" id="cleanup-hours-input" value="{{ config.LOG_CLEANUP_HOURS }}">
    </form>

    <!-- 独立的日志清空表单 -->
    <form method="post" action="{{ url_for('clear_logs_route') }}" class="d-none" id="clear-form"></form>

    <!-- 独立的下载内容清理表单 -->
    <form method="post" action="{{ url_for('cleanup_downloads_route') }}" class="d-none" id="download-cleanup-form">
    <input type="hidden" name="hours" id="download-cleanup-hours-input" value="{{ config.get('DOWNLOAD_CLEANUP_HOURS', 72) }}">
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const folders = document.querySelectorAll('.settings-nav-folder');

    const closeAllFoldersExcept = function (keepFolder) {
        folders.forEach(function (folder) {
            if (keepFolder && folder === keepFolder) {
                return;
            }
            const toggle = folder.querySelector('.settings-folder-toggle');
            const body = folder.querySelector('.settings-folder-body');
            if (!toggle || !body) return;
            toggle.setAttribute('aria-expanded', 'false');
            folder.classList.remove('open');
            body.classList.remove('show');
        });
    };

    folders.forEach(function (folder) {
        const toggle = folder.querySelector('.settings-folder-toggle');
        const body = folder.querySelector('.settings-folder-body');

        if (!toggle || !body) {
            return;
        }

        const setState = function (expanded) {
            toggle.setAttribute('aria-expanded', expanded);
            folder.classList.toggle('open', expanded);
            body.classList.toggle('show', expanded);
        };

        // 初始：全部收起（后续会根据 active tab 自动打开对应分组）
        setState(false);

        toggle.addEventListener('click', function () {
            const expanded = toggle.getAttribute('aria-expanded') === 'true';
            if (!expanded) {
                closeAllFoldersExcept(folder);
            }
            setState(!expanded);
        });
    });

    const openFolderForLink = function (linkEl) {
        if (!linkEl) return;
        const folder = linkEl.closest('.settings-nav-folder');
        if (!folder) return;
        closeAllFoldersExcept(folder);
        const toggle = folder.querySelector('.settings-folder-toggle');
        const body = folder.querySelector('.settings-folder-body');
        if (toggle && body) {
            toggle.setAttribute('aria-expanded', 'true');
            folder.classList.add('open');
            body.classList.add('show');
        }
    };

    // 支持 URL hash 直达子页面：#vtab-xxx
    const activateTabFromHash = function () {
        const hash = window.location.hash;
        if (!hash || !hash.startsWith('#vtab-')) {
            return false;
        }
        const link = document.querySelector('.settings-folder-body .nav-link[href="' + hash + '"]');
        if (!link) {
            return false;
        }
        const tab = bootstrap.Tab.getOrCreateInstance(link);
        tab.show();
        openFolderForLink(link);
        return true;
    };

    const activeLink = document.querySelector('.settings-folder-body .nav-link.active');
    // 先尝试从 hash 激活；否则打开默认 active
    if (!activateTabFromHash()) {
        openFolderForLink(activeLink);
    }

    // tab 切换时同步 hash，并自动展开对应分组
    document.querySelectorAll('.settings-folder-body .nav-link[data-bs-toggle="pill"]').forEach(function (link) {
        link.addEventListener('shown.bs.tab', function (event) {
            const href = event && event.target ? event.target.getAttribute('href') : null;
            if (href && href.startsWith('#')) {
                window.location.hash = href;
            }
            openFolderForLink(event.target);
        });
    });

    window.addEventListener('hashchange', function () {
        activateTabFromHash();
    });

    // 处理重置按钮点击
    const resetBtn = document.getElementById('reset-settings-btn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            // 获取当前激活的 tab
            const activeTab = document.querySelector('.tab-pane.active');
            if (!activeTab) {
                alert('无法确定当前设置页面');
                return;
            }

            // 获取该 tab 下的所有输入字段名称
            const inputs = activeTab.querySelectorAll('input[name], select[name], textarea[name]');
            const keys = Array.from(inputs).map(input => input.name).filter(name => name);

            if (keys.length === 0) {
                alert('当前页面没有可重置的设置项');
                return;
            }

            if (confirm('确定要将当前页面的设置重置为默认值吗？此操作不可撤销。')) {
                fetch('{{ url_for("reset_settings") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keys: keys })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.reload();
                    } else {
                        alert('重置失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('重置请求发生错误');
                });
            }
        });
    }
});
</script>
{% endblock %}