{% extends 'base.html' %}

{% block title %}Y2A-Auto - ç¼–è¾‘ä»»åŠ¡{% endblock %}

{% block content %}
<div class="edit-task-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ç¼–è¾‘ä»»åŠ¡</h2>
        <a href="{{ url_for('tasks') }}" class="btn btn-outline-secondary">è¿”å›ä»»åŠ¡åˆ—è¡¨</a>
    </div>
    
    {% if task %}
        <div class="row">
            <!-- å·¦ä¾§ä¿¡æ¯æ  -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        ä»»åŠ¡ä¿¡æ¯
                    </div>
                    <div class="card-body">
                        <p><strong>ä»»åŠ¡ID:</strong> {{ task.id }}</p>
                        <p><strong>åˆ›å»ºæ—¶é—´:</strong> {{ task.created_at }}</p>
                        <p><strong>çŠ¶æ€:</strong> 
                            <span class="badge rounded-pill bg-{{ task_status_color(task.status) }} task-status-badge">
                                {{ task_status_display(task.status) }}
                            </span>
                        </p>
                        <p><strong>YouTubeç½‘å€:</strong> <a href="{{ task.youtube_url }}" target="_blank" rel="noopener">{{ task.youtube_url }}</a></p>
                    </div>
                </div>
                
                {% if task.cover_path_local %}
                    <div class="card mb-4">
                        <div class="card-header">
                            è§†é¢‘å°é¢
                        </div>
                        <img src="{{ url_for('get_task_cover', task_id=task.id) }}" class="card-img-top" alt="è§†é¢‘å°é¢">
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cover-mode-switch" 
                                       {% if config.COVER_PROCESSING_MODE == 'crop' %}checked{% endif %}>
                                <label class="form-check-label" for="cover-mode-switch">
                                    ä½¿ç”¨è£å‰ªæ¨¡å¼ (å½“å‰: {{ 'è£å‰ª' if config.COVER_PROCESSING_MODE == 'crop' else 'å¡«å……' }})
                                </label>
                            </div>
                            <button class="btn btn-sm btn-primary mt-2" id="toggle-cover-mode">åˆ‡æ¢å°é¢å¤„ç†æ¨¡å¼</button>
                        </div>
                    </div>
                {% endif %}
                
                {% if task.moderation_result %}
                    <div class="card mb-4">
                        <div class="card-header">
                            å®¡æ ¸ç»“æœ
                        </div>
                        <div class="card-body">
                            {% set moderation = parse_json(task.moderation_result) %}
                            {% if moderation %}
                                {% if not moderation.overall_pass %}
                                    <div class="alert alert-danger">
                                        <i class="bi bi-x-circle"></i> <strong>å®¡æ ¸ä¸é€šè¿‡</strong>
                                </div>
                            {% else %}
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle"></i> <strong>å®¡æ ¸é€šè¿‡</strong> (è‹¥æœ‰ä»¥ä¸‹è¯¦æƒ…ï¼Œå»ºè®®æ£€æŸ¥)
                                    </div>
                                {% endif %}
                                
                                {% for content_type, result in [('æ ‡é¢˜', moderation.title), ('æè¿°', moderation.description)] %}
                                    {% if result and result.details %}
                                    <div class="moderation-item">
                                            <h6><i class="bi bi-exclamation-triangle"></i> {{ content_type }}é—®é¢˜:</h6>
                                            <ul class="list-group list-group-flush">
                                                {% for detail in result.details %}
                                                    <li class="list-group-item 
                                                       {% if detail.suggestion == 'block' %}list-group-item-danger
                                                       {% elif detail.suggestion == 'review' %}list-group-item-warning
                                                       {% else %}list-group-item-info{% endif %}">
                                                        <strong>{{ get_aliyun_label_chinese(detail.label) }}</strong>
                                                    {% if detail.description %}
                                                            <small class="text-muted"> ({{ detail.description }})</small>
                                                        {% endif %}
                                                        <br>
                                                        <small>
                                                            åŸå› : {{ detail.reason or 'æ— ' }}<br>
                                                            å»ºè®®: 
                                                            {% if detail.suggestion == 'block' %}é˜»æ­¢å‘å¸ƒ
                                                            {% elif detail.suggestion == 'review' %}äººå·¥å¤å®¡
                                                            {% else %}é€šè¿‡{% endif %}
                                                            {% if detail.confidence %}
                                                                (ç½®ä¿¡åº¦: {{ "%.2f"|format(detail.confidence) }}%)
                                                    {% endif %}
                                                        </small>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                                {% endfor %}
                                {% if moderation.tags and moderation.tags.details %}
                                    <div class="moderation-item">
                                        <h6><i class="bi bi-exclamation-triangle"></i> æ ‡ç­¾é—®é¢˜:</h6>
                                        <ul class="list-group list-group-flush">
                                            {% for detail in moderation.tags.details %}
                                                <li class="list-group-item 
                                                   {% if detail.suggestion == 'block' %}list-group-item-danger
                                                   {% elif detail.suggestion == 'review' %}list-group-item-warning
                                                   {% else %}list-group-item-info{% endif %}">
                                                    <strong>{{ get_aliyun_label_chinese(detail.label) }}</strong>
                                                    {% if detail.description %}
                                                        <small class="text-muted"> ({{ detail.description }})</small>
                                                    {% endif %}
                                                    <br>
                                                    <small>
                                                        åŸå› : {{ detail.reason or 'æ— ' }}<br>
                                                        å»ºè®®: 
                                                        {% if detail.suggestion == 'block' %}é˜»æ­¢å‘å¸ƒ
                                                        {% elif detail.suggestion == 'review' %}äººå·¥å¤å®¡
                                                        {% else %}é€šè¿‡{% endif %}
                                                        {% if detail.confidence %}
                                                            (ç½®ä¿¡åº¦: {{ "%.2f"|format(detail.confidence) }}%)
                                                        {% endif %}
                                                    </small>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-secondary">
                                    <i class="bi bi-info-circle"></i> æœªæ‰¾åˆ°å®¡æ ¸ç»“æœæˆ–å®¡æ ¸å·²è·³è¿‡ã€‚
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <!-- å³ä¾§ç¼–è¾‘è¡¨å• -->
            <div class="col-md-8">
                <form method="post" action="{{ url_for('edit_task', task_id=task.id) }}">
                    <div class="card mb-4">
                        <div class="card-header">
                            ç¼–è¾‘è§†é¢‘ä¿¡æ¯
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="video_title_translated" class="form-label">è§†é¢‘æ ‡é¢˜</label>
                                <input type="text" class="form-control" id="video_title_translated" name="video_title_translated" 
                                       value="{{ task.video_title_translated or task.video_title_original }}" required>
                                {% if task.video_title_original %}
                                    <div class="form-text">åŸå§‹æ ‡é¢˜: {{ task.video_title_original }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label for="description_translated" class="form-label">è§†é¢‘æè¿°</label>
                                <textarea class="form-control" id="description_translated" name="description_translated" 
                                          rows="10">{{ task.description_translated or task.description_original }}</textarea>
                                {% if task.description_original %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" data-bs-toggle="collapse" 
                                            data-bs-target="#original-description">
                                        æ˜¾ç¤º/éšè—åŸå§‹æè¿°
                                    </button>
                                    <div class="collapse mt-2" id="original-description">
                                        <div class="card card-body bg-light">
                                            <pre>{{ task.description_original }}</pre>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            åˆ†åŒºè®¾ç½®
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="selected_partition_id" class="form-label">é€‰æ‹©åˆ†åŒº</label>
                                <select class="form-select" id="selected_partition_id" name="selected_partition_id" required>
                                    <option value="">-- è¯·é€‰æ‹©åˆ†åŒº --</option>
                                    {% for category in id_mapping %}
                                        <optgroup label="{{ category.category }}">
                                            {% for partition in category.partitions %}
                                                <option value="{{ partition.id }}" 
                                                        {% if task.selected_partition_id == partition.id or 
                                                              (not task.selected_partition_id and task.recommended_partition_id == partition.id) %}
                                                            selected
                                                        {% endif %}>
                                                    {{ partition.name }} ({{ partition.id }})
                                                </option>
                                                {% for sub_partition in partition.sub_partitions %}
                                                    <option value="{{ sub_partition.id }}" 
                                                            {% if task.selected_partition_id == sub_partition.id or 
                                                                  (not task.selected_partition_id and task.recommended_partition_id == sub_partition.id) %}
                                                                selected
                                                            {% endif %}>
                                                        &nbsp;&nbsp;â”” {{ sub_partition.name }} ({{ sub_partition.id }})
                                                    </option>
                                                {% endfor %}
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                                {% if task.recommended_partition_id %}
                                    <div class="form-text">AIæ¨èåˆ†åŒº: {{ get_partition_name(task.recommended_partition_id) }} ({{ task.recommended_partition_id }})</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            æ ‡ç­¾è®¾ç½®
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">è§†é¢‘æ ‡ç­¾ï¼ˆæ¯ä¸ªä¸è¶…è¿‡20ä¸ªå­—ç¬¦ï¼Œæœ€å¤š6ä¸ªï¼‰</label>
                                <div class="row g-2">
                                    {% set tags = tags_string.split(',') if tags_string else [] %}
                                    {% for i in range(6) %}
                                    <div class="col-6 col-md-4">
                                        <input type="text" class="form-control tag-input" maxlength="20" name="tag_input_{{i}}" placeholder="æ ‡ç­¾{{i+1}}" value="{{ tags[i]|trim if tags|length > i else '' }}">
                                    </div>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="tags_json" name="tags_json" value="{{ task.tags_generated or '[]' }}">
                                <div class="form-text">æœ€å¤šå¯æ·»åŠ 6ä¸ªæ ‡ç­¾ï¼Œæ¯ä¸ªæ ‡ç­¾ä¸è¶…è¿‡20ä¸ªå­—ç¬¦</div>
                            </div>
                            <div id="tags-container" class="mb-3 d-flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-cloud-upload"></i> ä¿å­˜å¹¶ä¸Šä¼ åˆ°AcFun
                        </button>
                        <a href="{{ url_for('tasks') }}" class="btn btn-outline-secondary">å–æ¶ˆ</a>
                    </div>
                    
                    <div class="mt-3">
                        <div class="alert alert-info small">
                            <i class="bi bi-info-circle"></i> ç‚¹å‡»"ä¿å­˜å¹¶ä¸Šä¼ åˆ°AcFun"æŒ‰é’®åï¼Œç³»ç»Ÿå°†ä¿å­˜æ‚¨çš„ç¼–è¾‘å¹¶åœ¨åå°ä¸Šä¼ è§†é¢‘ã€‚
                            <br><strong>ğŸ’¡ ä¸Šä¼ å°†åœ¨åå°è¿›è¡Œï¼Œæ‚¨å¯ä»¥ç«‹å³è¿”å›ä»»åŠ¡åˆ—è¡¨ï¼Œæ— éœ€ç­‰å¾…ã€‚</strong>
                            {% if task.status == 'completed' %}
                                <br><strong>å½“å‰çŠ¶æ€ï¼šå·²å®Œæˆå¤„ç†ï¼Œå¯ä»¥ç›´æ¥ä¸Šä¼ </strong>
                            {% elif task.status == 'pending' %}
                                <br><strong>å½“å‰çŠ¶æ€ï¼šç­‰å¾…å¤„ç†ï¼Œç‚¹å‡»åå°†å¼€å§‹ä¸Šä¼ </strong>
                            {% elif task.status == 'ready_for_upload' %}
                                <br><strong>å½“å‰çŠ¶æ€ï¼šå‡†å¤‡ä¸Šä¼ ï¼Œå¯ä»¥ç›´æ¥ä¸Šä¼ </strong>
                            {% else %}
                                <br><strong>å½“å‰çŠ¶æ€ï¼š{{ task_status_display(task.status) }}ï¼Œéœ€è¦ç­‰å¾…å¤„ç†å®Œæˆåæ‰èƒ½ä¸Šä¼ </strong>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    {% else %}
        <div class="alert alert-danger">
            æœªæ‰¾åˆ°ä»»åŠ¡ä¿¡æ¯ï¼Œè¯·è¿”å›<a href="{{ url_for('tasks') }}">ä»»åŠ¡åˆ—è¡¨</a>é‡æ–°é€‰æ‹©ã€‚
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // æ ‡ç­¾ç®¡ç†
        const tagInputs = document.querySelectorAll('.tag-input');
        const tagsJsonField = document.getElementById('tags_json');
        const tagsContainer = document.getElementById('tags-container');
        
        // åˆå§‹åŒ–æ ‡ç­¾æ˜¾ç¤º
        function updateTagsDisplay() {
            tagsContainer.innerHTML = '';
            try {
                const tags = JSON.parse(tagsJsonField.value);
                tags.forEach((tag, index) => {
                    if (!tag) return;
                    const tagElement = document.createElement('div');
                    tagElement.className = 'badge bg-primary d-flex align-items-center';
                    tagElement.style.fontSize = '14px';
                    tagElement.innerHTML = `
                        <span class="me-2">${tag}</span>
                    `;
                    tagsContainer.appendChild(tagElement);
                });
            } catch (e) {
                console.error('è§£ææ ‡ç­¾å‡ºé”™:', e);
            }
        }
        
        // æ”¶é›†æ‰€æœ‰è¾“å…¥æ¡†çš„æ ‡ç­¾ï¼Œå»é‡ã€å»ç©ºã€é™åˆ¶é•¿åº¦
        function collectTags() {
            const tags = [];
            tagInputs.forEach(input => {
                let val = input.value.trim();
                if (val && val.length <= 20 && !tags.includes(val)) {
                    tags.push(val);
                }
            });
                tagsJsonField.value = JSON.stringify(tags);
                updateTagsDisplay();
        }
        
        // ç»‘å®šè¾“å…¥äº‹ä»¶
        tagInputs.forEach(input => {
            input.addEventListener('input', collectTags);
        });

        // åˆå§‹åŒ–æ—¶åŒæ­¥ä¸€æ¬¡
        collectTags();

        // æäº¤å‰æ”¶é›†ä¸€æ¬¡ï¼Œé˜²æ­¢é—æ¼
        const form = tagsJsonField.closest('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                collectTags();
            });
        }
        
        // å°é¢å¤„ç†æ¨¡å¼åˆ‡æ¢
        const coverModeSwitch = document.getElementById('cover-mode-switch');
        const toggleCoverModeBtn = document.getElementById('toggle-cover-mode');
        
        if (toggleCoverModeBtn) {
            toggleCoverModeBtn.addEventListener('click', function() {
                const newMode = coverModeSwitch.checked ? 'crop' : 'pad';
                
                fetch('/settings/update_cover_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mode: newMode,
                        task_id: '{{ task.id }}'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°å°é¢
                        location.reload();
                    } else {
                        alert('æ›´æ–°å°é¢å¤„ç†æ¨¡å¼å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('æ›´æ–°å°é¢å¤„ç†æ¨¡å¼å‡ºé”™:', error);
                    alert('æ›´æ–°å¤±è´¥: ' + error);
                });
            });
        }
        
        updateTagsDisplay();
    });
</script>
{% endblock %}

{% block extra_css %}
<style>
    .moderation-item {
        margin-bottom: 15px;
    }
    
    pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 300px;
        overflow-y: auto;
    }
</style>
{% endblock %} 